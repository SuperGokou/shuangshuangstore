<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>觉觉在北美 — Inventory Manager</title>
    <link rel="icon" href="img/icon.png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <div class="brand-title">觉觉在北美 <span class="brand-handle">(amtfmz)</span></div>
            <div class="brand-subtitle">Inventory Manager</div>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-page="dashboard">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                Dashboard
            </a>
            <a href="#" class="nav-item" data-page="inventory">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                Inventory
            </a>
            <a href="#" class="nav-item" data-page="purchase">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Purchase Orders
            </a>
            <a href="#" class="nav-item" data-page="shipping">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                Shipments
            </a>
            <a href="#" class="nav-item" data-page="analytics">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                Analytics
            </a>
        </nav>
    </aside>

    <!-- Mobile hamburger -->
    <button class="hamburger" id="hamburger" aria-label="Toggle sidebar">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>

    <!-- Main content -->
    <div class="main-content">
        <!-- Top header bar (Figma Header.tsx) -->
        <header class="top-bar">
            <div class="top-bar-left">
                <div class="search-box">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" placeholder="Search..." id="search-input">
                </div>
            </div>
            <div class="top-bar-right">
                <div class="update-badge">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    <span class="update-badge-text">Last Updated: <span id="last-updated">2m ago</span></span>
                </div>
                <button class="notification-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                    <span class="notification-dot"></span>
                </button>
                <div class="user-area">
                    <div class="user-avatar">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                    <div class="user-info">
                        <div class="user-name">Admin User</div>
                        <a href="pages/login.html" class="user-login">登陆 / Login</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- ==================== PAGE: DASHBOARD ==================== -->
        <div class="page" id="page-dashboard">
            <div class="page-content">
                <!-- Metric cards (Figma MetricCard.tsx style) -->
                <div class="metrics-row" id="metrics-row">
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">US Signed</div>
                                <div class="metric-value" id="metric-us-signed">—</div>
                                <div class="metric-trend">美国签收</div>
                            </div>
                            <div class="metric-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">US Unsigned</div>
                                <div class="metric-value" id="metric-us-unsigned">—</div>
                                <div class="metric-trend">美国未签</div>
                            </div>
                            <div class="metric-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">In Transit to China</div>
                                <div class="metric-value" id="metric-shipped-cn">—</div>
                                <div class="metric-trend">发往中国</div>
                            </div>
                            <div class="metric-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Total Stock</div>
                                <div class="metric-value" id="metric-total-stock">—</div>
                                <div class="metric-trend">商品总数</div>
                            </div>
                            <div class="metric-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Gallery -->
                <div class="content-card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">Product Inventory</h2>
                            <p class="card-desc">Live stock status for all products</p>
                        </div>
                    </div>
                    <div id="inventory-container" class="gallery-scroll">
                        <p style="text-align:center; width:100%; color:#94a3b8;">Loading products...</p>
                    </div>
                </div>

                <!-- Stats -->
                <div class="content-card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title"><span class="section-tag">Stats</span> 产品发货统计</h2>
                            <p class="card-desc">Shipment statistics by product</p>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="stats-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">图片</th>
                                    <th>产品名称</th>
                                    <th>已发总数</th>
                                    <th>带包装 (Qty)</th>
                                    <th>明细 (Details)</th>
                                    <th>不带包装 (Qty)</th>
                                    <th>明细 (Details)</th>
                                    <th>总库存</th>
                                </tr>
                            </thead>
                            <tbody id="stats-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders -->
                <div class="content-card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title"><span class="section-tag">Orders</span> 采购订单追踪</h2>
                            <p class="card-desc">Incoming orders tracking</p>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="order-table">
                            <thead>
                                <tr>
                                    <th>来源 (Source)</th>
                                    <th>订单号 (Order #)</th>
                                    <th>状态</th>
                                    <th>快递单号</th>
                                    <th>签收</th>
                                    <th>预计 (Est. Date)</th>
                                </tr>
                            </thead>
                            <tbody id="order-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== PAGE: INVENTORY ==================== -->
        <div class="page hidden" id="page-inventory">
            <div class="page-content">
                <div class="page-heading">
                    <h1 class="page-title">Inventory Management</h1>
                    <p class="page-desc">Monitor stock levels across all warehouses</p>
                </div>

                <!-- Inventory metric cards -->
                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Total SKUs</div>
                                <div class="metric-value" id="inv-metric-skus">—</div>
                            </div>
                            <div class="metric-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Low Stock Items</div>
                                <div class="metric-value text-amber" id="inv-metric-low">—</div>
                            </div>
                            <div class="metric-icon icon-partial">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Out of Stock</div>
                                <div class="metric-value text-red" id="inv-metric-out">—</div>
                            </div>
                            <div class="metric-icon icon-delayed">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Total Stock</div>
                                <div class="metric-value" id="inv-metric-total">—</div>
                            </div>
                            <div class="metric-icon icon-fulfilled">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Table Card with Toolbar -->
                <div class="content-card">
                    <div class="card-header" style="flex-direction:column; align-items:stretch; gap:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <h2 class="card-title">Inventory Items</h2>
                                <p class="card-desc"><span id="inv-count-info">— products</span></p>
                            </div>
                            <div class="view-toggle">
                                <button class="view-btn active" data-view="table" onclick="setInventoryView('table')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                                </button>
                                <button class="view-btn" data-view="grid" onclick="setInventoryView('grid')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                                </button>
                                <button class="view-btn" data-view="list" onclick="setInventoryView('list')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="card-toolbar">
                            <div class="search-box" style="flex:1;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                <input type="text" placeholder="Search by name..." id="inv-search" oninput="filterInventory()">
                            </div>
                            <select class="sort-select" id="inv-sort" onchange="filterInventory()">
                                <option value="name">Sort by Name</option>
                                <option value="total-desc">Total (High→Low)</option>
                                <option value="total-asc">Total (Low→High)</option>
                                <option value="signed-desc">US Signed (High→Low)</option>
                                <option value="status">Status</option>
                            </select>
                            <button class="toolbar-btn primary" onclick="exportInventory()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Export All
                            </button>
                        </div>
                    </div>
                    <div id="inventory-view-container">
                        <div class="table-wrapper" id="inv-table-view">
                            <table id="inventory-table">
                                <thead>
                                    <tr>
                                        <th style="width:60px;">Image</th>
                                        <th>Product Name</th>
                                        <th>US Signed</th>
                                        <th>US Unsigned</th>
                                        <th>Shipped to CN</th>
                                        <th>Total Stock</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-body"></tbody>
                            </table>
                        </div>
                        <div id="inv-grid-view" class="inventory-grid" style="display:none;"></div>
                        <div id="inv-list-view" class="inventory-list" style="display:none;"></div>
                    </div>
                </div>

                <!-- Stats Table -->
                <div class="content-card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title"><span class="section-tag">Stats</span> 产品发货统计</h2>
                            <p class="card-desc">Shipment statistics by product</p>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="inv-stats-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">图片</th>
                                    <th>产品名称</th>
                                    <th>已发总数</th>
                                    <th>带包装 (Qty)</th>
                                    <th>明细 (Details)</th>
                                    <th>不带包装 (Qty)</th>
                                    <th>明细 (Details)</th>
                                    <th>总库存</th>
                                </tr>
                            </thead>
                            <tbody id="inv-stats-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== PAGE: PURCHASE ORDERS ==================== -->
        <div class="page hidden" id="page-purchase">
            <div class="page-content">
                <div class="page-heading">
                    <h1 class="page-title">Purchase Orders</h1>
                    <p class="page-desc">Manage and track all purchase orders</p>
                </div>

                <!-- 5 metric cards (Figma PurchaseOrdersPage) -->
                <div class="metrics-row metrics-row-5">
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Total Orders</div>
                                <div class="metric-value" id="po-metric-orders">—</div>
                            </div>
                            <div class="metric-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Total Items</div>
                                <div class="metric-value text-green" id="po-metric-items">—</div>
                            </div>
                            <div class="metric-icon icon-fulfilled">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Sources</div>
                                <div class="metric-value text-blue" id="po-metric-sources">—</div>
                            </div>
                            <div class="metric-icon icon-transit">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Shipments</div>
                                <div class="metric-value text-amber" id="po-metric-shipments">—</div>
                            </div>
                            <div class="metric-icon icon-partial">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Signed</div>
                                <div class="metric-value text-muted" id="po-metric-signed">—</div>
                            </div>
                            <div class="metric-icon icon-pending">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purchase orders table card with toolbar -->
                <div class="content-card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">All Purchase Orders</h2>
                            <p class="card-desc">Complete order history and tracking</p>
                        </div>
                        <div class="card-toolbar">
                            <div class="search-box">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                <input type="text" placeholder="Search orders..." id="po-search" oninput="filterPurchaseOrders()">
                            </div>
                            <button class="toolbar-btn primary" onclick="exportPurchaseOrders()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="scroll-table-wrapper">
                        <table id="purchase-table">
                            <thead>
                                <tr>
                                    <th style="min-width: 100px;">日期 (Date)</th>
                                    <th style="min-width: 120px;">来源 (Source)</th>
                                    <th style="min-width: 300px;">产品明细 (Items)</th>
                                    <th style="min-width: 180px;">快递单号 (Tracking)</th>
                                    <th style="min-width: 120px;">备注 (Note)</th>
                                </tr>
                            </thead>
                            <tbody id="purchase-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== PAGE: SHIPMENTS ==================== -->
        <div class="page hidden" id="page-shipping">
            <div class="page-content">
                <div class="page-heading">
                    <h1 class="page-title">Shipments</h1>
                    <p class="page-desc">Track and manage all shipments</p>
                </div>

                <!-- 4 metric cards (Figma ShipmentsPage) -->
                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Total Shipments</div>
                                <div class="metric-value" id="sh-metric-total">—</div>
                            </div>
                            <div class="metric-icon icon-transit">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Recipients</div>
                                <div class="metric-value text-green" id="sh-metric-recipients">—</div>
                            </div>
                            <div class="metric-icon icon-fulfilled">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Total Weight</div>
                                <div class="metric-value" id="sh-metric-weight">—</div>
                                <div class="metric-trend">lbs</div>
                            </div>
                            <div class="metric-icon icon-partial">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div>
                                <div class="metric-title">Avg Weight</div>
                                <div class="metric-value" id="sh-metric-avg">—</div>
                                <div class="metric-trend">lbs per shipment</div>
                            </div>
                            <div class="metric-icon icon-pending">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipments table card with toolbar -->
                <div class="content-card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">Active Shipments</h2>
                            <p class="card-desc">Real-time tracking and status updates</p>
                        </div>
                        <div class="card-toolbar">
                            <div class="search-box">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                <input type="text" placeholder="Search tracking number..." id="sh-search" oninput="filterShipments()">
                            </div>
                            <button class="toolbar-btn primary" onclick="exportShipments()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="shipping-table">
                            <thead>
                                <tr>
                                    <th>运单号</th>
                                    <th>收件人</th>
                                    <th>内件明细</th>
                                    <th>重量(lbs)</th>
                                    <th>状态</th>
                                    <th>电话</th>
                                    <th>地址</th>
                                </tr>
                            </thead>
                            <tbody id="shipping-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== PAGE: ANALYTICS ==================== -->
        <div class="page hidden" id="page-analytics">
            <div class="page-content">
                <div class="page-heading">
                    <h1 class="page-title">Analytics</h1>
                    <p class="page-desc">Business intelligence and performance metrics</p>
                </div>

                <!-- KPI Cards with trend arrows (Figma AnalyticsPage) -->
                <div class="metrics-row" id="analytics-kpi-row">
                    <div class="kpi-card">
                        <div class="kpi-top">
                            <div class="kpi-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                            </div>
                            <div class="kpi-trend up" id="an-trend-shipped">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                                <span>—</span>
                            </div>
                        </div>
                        <div class="kpi-title">Total Items Shipped</div>
                        <div class="kpi-value" id="an-metric-shipped">—</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-top">
                            <div class="kpi-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                            </div>
                            <div class="kpi-trend up" id="an-trend-orders">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                                <span>—</span>
                            </div>
                        </div>
                        <div class="kpi-title">Orders (Total)</div>
                        <div class="kpi-value" id="an-metric-orders">—</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-top">
                            <div class="kpi-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                            </div>
                            <div class="kpi-trend down" id="an-trend-avg">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>
                                <span>—</span>
                            </div>
                        </div>
                        <div class="kpi-title">Avg Items/Order</div>
                        <div class="kpi-value" id="an-metric-avg">—</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-top">
                            <div class="kpi-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                            </div>
                            <div class="kpi-trend up" id="an-trend-turnover">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                                <span>—</span>
                            </div>
                        </div>
                        <div class="kpi-title">Inventory Turnover</div>
                        <div class="kpi-value" id="an-metric-turnover">—</div>
                    </div>
                </div>

                <!-- Charts Row (Figma: 2fr 1fr) -->
                <div class="charts-row">
                    <div class="content-card chart-card">
                        <div class="card-header">
                            <div>
                                <h2 class="card-title">Stock by Product</h2>
                                <p class="card-desc">Total stock levels per product</p>
                            </div>
                        </div>
                        <div class="chart-container" id="bar-chart"></div>
                    </div>

                    <div class="content-card chart-card">
                        <div class="card-header">
                            <div>
                                <h2 class="card-title">Category Distribution</h2>
                                <p class="card-desc">Stock distribution by status</p>
                            </div>
                        </div>
                        <div class="chart-container pie-container">
                            <div class="pie-chart" id="pie-chart"></div>
                            <div class="pie-legend" id="pie-legend"></div>
                        </div>
                    </div>
                </div>

                <!-- Shipment Volume -->
                <div class="charts-row charts-row-2col">
                    <div class="content-card">
                        <div class="card-header">
                            <div>
                                <h2 class="card-title">Shipment Volume by Product</h2>
                                <p class="card-desc">已发总数 — items shipped per product</p>
                            </div>
                        </div>
                        <div class="chart-container" id="shipment-bar-chart"></div>
                    </div>

                    <!-- Source Performance -->
                    <div class="content-card">
                        <div class="card-header">
                            <div>
                                <h2 class="card-title">Source Performance</h2>
                                <p class="card-desc">Supplier comparison metrics</p>
                            </div>
                        </div>
                        <div id="source-performance" class="source-perf-grid"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-spacer"></div>
    </div>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <script>
    // ========== NAVIGATION ==========
    const navItems = document.querySelectorAll('.nav-item[data-page]');
    const pages = document.querySelectorAll('.page');
    const hamburgerBtn = document.getElementById('hamburger');
    const sidebarEl = document.getElementById('sidebar');
    const overlayEl = document.getElementById('sidebar-overlay');

    function navigateTo(pageId) {
        pages.forEach(p => p.classList.add('hidden'));
        navItems.forEach(n => n.classList.remove('active'));
        const target = document.getElementById('page-' + pageId);
        if (target) target.classList.remove('hidden');
        const navEl = document.querySelector(`.nav-item[data-page="${pageId}"]`);
        if (navEl) navEl.classList.add('active');
        sidebarEl.classList.remove('open');
        overlayEl.classList.remove('open');
        window.scrollTo(0, 0);
    }

    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(item.dataset.page);
        });
    });

    hamburgerBtn.addEventListener('click', () => {
        sidebarEl.classList.toggle('open');
        overlayEl.classList.toggle('open');
    });
    overlayEl.addEventListener('click', () => {
        sidebarEl.classList.remove('open');
        overlayEl.classList.remove('open');
    });

    // ========== INVENTORY VIEW MODE ==========
    let currentView = 'table';
    function setInventoryView(mode) {
        currentView = mode;
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.view-btn[data-view="${mode}"]`).classList.add('active');
        document.getElementById('inv-table-view').style.display = mode === 'table' ? '' : 'none';
        document.getElementById('inv-grid-view').style.display = mode === 'grid' ? '' : 'none';
        document.getElementById('inv-list-view').style.display = mode === 'list' ? '' : 'none';
    }

    // ========== DATA STORE ==========
    let allProducts = [];
    let allStats = [];
    let allOrders = [];
    let allShipping = [];
    let purchaseOrders = [];

    // ========== FETCH ALL DATA ==========
    Promise.all([
        fetch('data/products.json').then(r => r.ok ? r.json() : []),
        fetch('data/stats.json').then(r => r.ok ? r.json() : []),
        fetch('data/orders.json').then(r => r.ok ? r.json() : []),
        fetch('data/shipping.json').then(r => r.ok ? r.json() : []),
        fetch('data/purchase_orders.json').then(r => r.ok ? r.json() : [])
    ]).then(([products, stats, orders, shipping, purchases]) => {
        allProducts = products;
        allStats = stats;
        allOrders = orders;
        allShipping = shipping;
        purchaseOrders = purchases;

        renderDashboard();
        renderInventoryPage();
        renderPurchasePage();
        renderShippingPage();
        renderAnalyticsPage();
    }).catch(err => console.error("Data load error:", err));

    // ========== DASHBOARD ==========
    function renderDashboard() {
        let totalSigned = 0, totalUnsigned = 0, totalShippedCn = 0, totalStock = 0;
        const container = document.getElementById('inventory-container');
        container.innerHTML = '';

        allProducts.forEach(product => {
            const usSigned = product.us_signed || 0;
            const usUnsigned = product.us_unsigned || 0;
            const shippedCn = product.shipped_cn || 0;
            const stock = product.total_stock || 0;
            totalSigned += usSigned;
            totalUnsigned += usUnsigned;
            totalShippedCn += shippedCn;
            totalStock += stock;

            const card = document.createElement('div');
            card.className = 'card';
            const safeImagePath = encodeURI(product.image);
            card.innerHTML = `
                <div class="image-wrapper">
                    <img src="${safeImagePath}" alt="${product.name}" loading="lazy"
                         onerror="this.src='https://via.placeholder.com/300?text=No+Image'">
                </div>
                <div class="info">
                    <h3 style="text-align:center;">${product.name}</h3>
                    <div class="stock-data">
                        <div class="stock-row"><span class="stock-label">美国签收:</span><span class="stock-value" style="color:#10b981;">${usSigned}</span></div>
                        <div class="stock-row"><span class="stock-label">美国未签:</span><span class="stock-value" style="color:#f59e0b;">${usUnsigned}</span></div>
                        <div class="stock-row"><span class="stock-label">发往中国:</span><span class="stock-value">${shippedCn}</span></div>
                        <div style="border-top:1px solid #e2e8f0; margin-top:2px; padding-top:2px;" class="stock-row">
                            <span class="stock-label">商品总数:</span><span class="stock-value"><strong>${stock}</strong></span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });

        document.getElementById('metric-us-signed').textContent = totalSigned.toLocaleString();
        document.getElementById('metric-us-unsigned').textContent = totalUnsigned.toLocaleString();
        document.getElementById('metric-shipped-cn').textContent = totalShippedCn.toLocaleString();
        document.getElementById('metric-total-stock').textContent = totalStock.toLocaleString();

        renderStatsTable('stats-body', allStats);
        renderOrdersTable();
    }

    function renderStatsTable(tbodyId, stats) {
        const tbody = document.getElementById(tbodyId);
        if (stats.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8">No stats available</td></tr>';
            return;
        }
        stats.forEach(item => {
            const row = document.createElement('tr');
            const safeImg = encodeURI(item.image || '');
            row.innerHTML = `
                <td>
                    <div class="image-wrapper" style="width: 50px; height: 50px; padding-top:0;">
                        <img src="${safeImg}" alt="img" style="position:static; width:100%; height:100%; object-fit:contain; padding:2px;"
                             onerror="this.src='https://via.placeholder.com/50?text=?'">
                    </div>
                </td>
                <td style="font-weight:600; color:#0f172a;">${item['产品名称']}</td>
                <td style="font-size:1.05em; font-weight:700;">${item['已发总数']}</td>
                <td style="font-weight:600; color:#10b981; text-align:center;">${item['带包装']}</td>
                <td style="font-size:0.82em; color:#64748b; max-width:150px;">${item['带包装详情']}</td>
                <td style="font-weight:600; color:#ef4444; text-align:center;">${item['不带包装']}</td>
                <td style="font-size:0.82em; color:#64748b; max-width:150px;">${item['不带包装详情']}</td>
                <td style="font-weight:700;">${item['总库存']}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderOrdersTable() {
        const tbody = document.getElementById('order-body');
        if (allOrders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No orders found.</td></tr>';
            return;
        }
        allOrders.forEach(order => {
            const row = document.createElement('tr');
            const statusMap = {
                'Fulfilled': 'badge-fulfilled', 'Shipped': 'badge-fulfilled',
                'Partial': 'badge-partial', 'In Transit': 'badge-transit',
                'Pending': 'badge-pending'
            };
            const badgeClass = statusMap[order.status] || 'badge-pending';
            let signedText = order.signed;
            let signedColor = 'color:#10b981;';
            if (String(signedText).includes('No') || String(signedText).includes('否')) {
                signedColor = 'color:#ef4444; font-weight:600;';
            }
            let trackingDisplay = order.tracking;
            if (order.tracking_url && order.tracking !== '——' && order.tracking !== '-') {
                trackingDisplay = `<a href="${order.tracking_url}" target="_blank">${order.tracking}</a>`;
            }
            // Source dot
            const sourceDotClass = order.source.toLowerCase().includes('stanley') ? 'stanley' :
                                   order.source.toLowerCase().includes('love') ? 'loveshack' : 'default';
            row.innerHTML = `
                <td><span class="source-dot ${sourceDotClass}"></span>${order.source}</td>
                <td>${order.order_id}</td>
                <td><span class="badge ${badgeClass}">${order.status}</span></td>
                <td class="tracking-code">${trackingDisplay}</td>
                <td style="${signedColor}">${signedText}</td>
                <td>${order.est_date || '——'}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // ========== INVENTORY PAGE ==========
    function getInventoryStatus(product) {
        const stock = product.total_stock || 0;
        const unsigned = product.us_unsigned || 0;
        if (stock === 0) return { label: 'Out of Stock', class: 'badge-out-of-stock' };
        if (stock < 5) return { label: 'Low Stock', class: 'badge-low-stock' };
        if (unsigned > 0) return { label: 'In Transit', class: 'badge-transit' };
        return { label: 'In Stock', class: 'badge-in-stock' };
    }

    function getFilteredProducts() {
        const query = (document.getElementById('inv-search')?.value || '').toLowerCase();
        const sortBy = document.getElementById('inv-sort')?.value || 'name';

        let filtered = allProducts.filter(p =>
            !query || p.name.toLowerCase().includes(query)
        );

        filtered.sort((a, b) => {
            switch (sortBy) {
                case 'total-desc': return (b.total_stock || 0) - (a.total_stock || 0);
                case 'total-asc': return (a.total_stock || 0) - (b.total_stock || 0);
                case 'signed-desc': return (b.us_signed || 0) - (a.us_signed || 0);
                case 'status':
                    const sa = getInventoryStatus(a).label;
                    const sb = getInventoryStatus(b).label;
                    return sa.localeCompare(sb);
                default: return a.name.localeCompare(b.name);
            }
        });
        return filtered;
    }

    function filterInventory() {
        renderInventoryViews(getFilteredProducts());
    }

    function renderInventoryPage() {
        let totalStock = 0, lowStock = 0, outOfStock = 0;
        allProducts.forEach(p => {
            const stock = p.total_stock || 0;
            totalStock += stock;
            if (stock === 0) outOfStock++;
            else if (stock < 5) lowStock++;
        });

        document.getElementById('inv-metric-skus').textContent = allProducts.length;
        document.getElementById('inv-metric-low').textContent = lowStock;
        document.getElementById('inv-metric-out').textContent = outOfStock;
        document.getElementById('inv-metric-total').textContent = totalStock.toLocaleString();

        renderInventoryViews(allProducts);
        renderStatsTable('inv-stats-body', allStats);
    }

    function renderInventoryViews(products) {
        document.getElementById('inv-count-info').textContent =
            `${products.length} of ${allProducts.length} products`;

        // Table view
        const tbody = document.getElementById('inventory-body');
        tbody.innerHTML = '';
        products.forEach(product => {
            const usSigned = product.us_signed || 0;
            const usUnsigned = product.us_unsigned || 0;
            const shippedCn = product.shipped_cn || 0;
            const stock = product.total_stock || 0;
            const safeImg = encodeURI(product.image || '');
            const status = getInventoryStatus(product);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="image-wrapper" style="width:48px; height:48px; padding-top:0;">
                        <img src="${safeImg}" alt="${product.name}" style="position:static; width:100%; height:100%; object-fit:contain; padding:2px;"
                             onerror="this.src='https://via.placeholder.com/48?text=?'">
                    </div>
                </td>
                <td style="font-weight:600; color:#0f172a;">${product.name}</td>
                <td style="color:#10b981; font-weight:600;">${usSigned}</td>
                <td style="color:#f59e0b; font-weight:600;">${usUnsigned}</td>
                <td>${shippedCn}</td>
                <td style="font-weight:700;">${stock}</td>
                <td><span class="badge ${status.class}">${status.label}</span></td>
            `;
            tbody.appendChild(row);
        });

        // Grid view
        const gridContainer = document.getElementById('inv-grid-view');
        gridContainer.innerHTML = '';
        products.forEach(product => {
            const safeImg = encodeURI(product.image || '');
            const status = getInventoryStatus(product);
            gridContainer.innerHTML += `
                <div class="grid-card">
                    <img class="grid-card-img" src="${safeImg}" alt="${product.name}"
                         onerror="this.src='https://via.placeholder.com/240?text=No+Image'">
                    <div class="grid-card-body">
                        <div class="grid-card-name">${product.name}</div>
                        <div class="grid-card-stats">
                            <span>US Signed: <strong>${product.us_signed || 0}</strong></span>
                            <span>US Unsigned: <strong>${product.us_unsigned || 0}</strong></span>
                            <span>In Transit: <strong>${product.shipped_cn || 0}</strong></span>
                            <span>Total: <strong>${product.total_stock || 0}</strong></span>
                        </div>
                        <div class="grid-card-footer">
                            <span class="badge ${status.class}">${status.label}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        // List view
        const listContainer = document.getElementById('inv-list-view');
        listContainer.innerHTML = '';
        products.forEach(product => {
            const safeImg = encodeURI(product.image || '');
            const status = getInventoryStatus(product);
            listContainer.innerHTML += `
                <div class="list-item">
                    <img class="list-item-img" src="${safeImg}" alt="${product.name}"
                         onerror="this.src='https://via.placeholder.com/64?text=?'">
                    <div class="list-item-info">
                        <div class="list-item-name">${product.name}</div>
                        <div class="list-item-meta">
                            <span>US Signed: <strong>${product.us_signed || 0}</strong></span>
                            <span>US Unsigned: <strong>${product.us_unsigned || 0}</strong></span>
                            <span>In Transit: <strong>${product.shipped_cn || 0}</strong></span>
                            <span>Total: <strong>${product.total_stock || 0}</strong></span>
                        </div>
                    </div>
                    <span class="badge ${status.class}">${status.label}</span>
                </div>
            `;
        });
    }

    function exportInventory() {
        alert('Export ' + allProducts.length + ' items to CSV');
    }

    // ========== PURCHASE ORDERS PAGE ==========
    function toggleSignStatus(orderIndex, shipmentIndex, isChecked) {
        const order = purchaseOrders[orderIndex];
        if (!order || !order.shipments) return;
        const shipment = order.shipments[shipmentIndex];
        shipment.local_signed = isChecked ? 'Yes' : 'No';
        const uniqueKey = `${order.order_id}_${shipment.tracking_number}`;
        const savedState = JSON.parse(localStorage.getItem('purchase_signed_state') || '{}');
        if (isChecked) savedState[uniqueKey] = 'Yes';
        else delete savedState[uniqueKey];
        localStorage.setItem('purchase_signed_state', JSON.stringify(savedState));
    }
    window.toggleSignStatus = toggleSignStatus;

    function renderPurchasePage() {
        const savedState = JSON.parse(localStorage.getItem('purchase_signed_state') || '{}');
        const tbody = document.getElementById('purchase-body');
        tbody.innerHTML = '';

        if (purchaseOrders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No purchase history found.</td></tr>';
            return;
        }

        let totalItems = 0, totalShipments = 0, totalSigned = 0;
        const sources = new Set();

        purchaseOrders.forEach((order, orderIndex) => {
            sources.add(order.source);
            if (order.items) order.items.forEach(i => { totalItems += Math.abs(i.qty || 0); });
            if (order.shipments) {
                totalShipments += order.shipments.length;
                order.shipments.forEach(s => {
                    const uniqueKey = `${order.order_id}_${s.tracking_number}`;
                    const isSigned = savedState[uniqueKey] === 'Yes' || s.signed === 'Yes' || s.signed === '是';
                    if (isSigned) totalSigned++;
                });
            }

            const row = document.createElement('tr');
            const sourceDotClass = order.source.toLowerCase().includes('stanley') ? 'stanley' :
                                   order.source.toLowerCase().includes('love') ? 'loveshack' : 'default';

            let itemsHtml = '<div style="display:flex; flex-direction:column; gap:6px;">';
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    const safeImg = encodeURI(item.image || '');
                    itemsHtml += `
                        <div style="display:flex; align-items:center; gap:8px; border-bottom:1px solid #f1f5f9; padding-bottom:4px;">
                            <div style="width:36px; height:36px; flex-shrink:0; background:#fff;">
                                <img src="${safeImg}" alt="img" style="width:100%; height:100%; object-fit:contain;"
                                     onerror="this.src='https://via.placeholder.com/40?text=?'">
                            </div>
                            <div style="font-size:0.85em; line-height:1.3; white-space:normal;">
                                <div style="font-weight:600; color:#0f172a;">${item.product}</div>
                                <div style="color:#64748b;">Qty: <span style="color:#10b981; font-weight:600;">${item.qty}</span></div>
                            </div>
                        </div>
                    `;
                });
            }
            itemsHtml += '</div>';

            let trackingHtml = '<span style="color:#94a3b8;">-</span>';
            if (order.shipments && order.shipments.length > 0) {
                trackingHtml = order.shipments.map((s, shipmentIndex) => {
                    const fullNum = s.tracking_number;
                    const uniqueKey = `${order.order_id}_${fullNum}`;
                    let isSigned = false;
                    if (savedState[uniqueKey]) {
                        isSigned = savedState[uniqueKey] === 'Yes';
                    } else {
                        isSigned = s.signed === 'Yes' || s.signed === '是';
                    }
                    const checkedAttr = isSigned ? 'checked' : '';
                    return `
                    <div style="margin-bottom:5px; display:flex; align-items:center; gap:6px;">
                        <input type="checkbox"
                               style="cursor:pointer; accent-color:#1e3a8a; width:14px; height:14px;"
                               ${checkedAttr}
                               onchange="toggleSignStatus(${orderIndex}, ${shipmentIndex}, this.checked)"
                               title="Mark as signed">
                        <span style="font-size:0.75em; color:#64748b; font-weight:600;">${s.carrier}:</span>
                        <a href="${s.tracking_url}" target="_blank" title="${fullNum}"
                           style="font-family:'SF Mono','Cascadia Code','Courier New',monospace; font-size:0.85em;">
                            ${fullNum}
                        </a>
                    </div>`;
                }).join('');
            }

            let noteStyle = 'font-weight:600; color:#f59e0b;';
            const noteText = order.note || '';
            if (noteText.includes('已发货') && noteText.includes('已签收')) {
                noteStyle = 'font-weight:600; color:#10b981;';
            } else if (noteText.includes('已发货') && noteText.includes('未签收')) {
                noteStyle = 'font-weight:600; color:#3b82f6;';
            } else if (noteText.includes('退货')) {
                noteStyle = 'font-weight:600; color:#10b981;';
            }

            row.innerHTML = `
                <td style="font-size:0.85em; color:#64748b;">${order.date}</td>
                <td>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span class="source-dot ${sourceDotClass}"></span>
                        <div>
                            <div style="font-weight:600;">${order.source}</div>
                            <div style="font-size:0.78em; color:#94a3b8;">${order.order_id}</div>
                        </div>
                    </div>
                </td>
                <td style="white-space:normal; min-width:300px;">${itemsHtml}</td>
                <td>${trackingHtml}</td>
                <td style="${noteStyle}">${order.note || '-'}</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('po-metric-orders').textContent = purchaseOrders.length.toLocaleString();
        document.getElementById('po-metric-items').textContent = totalItems.toLocaleString();
        document.getElementById('po-metric-sources').textContent = sources.size.toLocaleString();
        document.getElementById('po-metric-shipments').textContent = totalShipments.toLocaleString();
        document.getElementById('po-metric-signed').textContent = totalSigned.toLocaleString();
    }

    function filterPurchaseOrders() {
        const query = (document.getElementById('po-search')?.value || '').toLowerCase();
        const rows = document.querySelectorAll('#purchase-body tr');
        rows.forEach(row => {
            row.style.display = !query || row.textContent.toLowerCase().includes(query) ? '' : 'none';
        });
    }

    function exportPurchaseOrders() {
        alert('Export ' + purchaseOrders.length + ' purchase orders to CSV');
    }

    // ========== SHIPPING PAGE ==========
    function renderShippingPage() {
        const tbody = document.getElementById('shipping-body');
        if (allShipping.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No shipping data found.</td></tr>';
            return;
        }

        let totalWeight = 0;
        const recipients = new Set();

        allShipping.forEach(item => {
            const w = parseFloat(item.weight || item['实际重量'] || 0);
            totalWeight += isNaN(w) ? 0 : w;
            recipients.add(item.customer_name || item.recipient || '');

            const row = document.createElement('tr');
            const details = item.details || item['内件明细'] || '——';
            const weight = item.weight || item['实际重量'] || '——';
            let trackingDisplay = item.tracking_number;
            if (item.tracking_url) {
                trackingDisplay = `<a href="${item.tracking_url}" target="_blank">${item.tracking_number}</a>`;
            }
            let fullAddress = item.address || '';
            let displayAddress = fullAddress;
            if (fullAddress.length > 25) {
                displayAddress = fullAddress.substring(0, 9) + "......" + fullAddress.substring(fullAddress.length - 9);
            }
            let fullStatus = item.status || 'Checking...';
            let displayStatus = fullStatus;
            if (fullStatus.length > 16) {
                displayStatus = fullStatus.substring(0, 16) + '...';
            }
            // Status badge class
            let statusClass = 'badge-pending';
            const sl = fullStatus.toLowerCase();
            if (sl.includes('deliver') || sl.includes('签收')) statusClass = 'badge-delivered';
            else if (sl.includes('transit') || sl.includes('运输')) statusClass = 'badge-transit';
            else if (sl.includes('delay')) statusClass = 'badge-delayed';
            else if (sl.includes('process')) statusClass = 'badge-processing';

            row.innerHTML = `
                <td class="tracking-code">${trackingDisplay}</td>
                <td>${item.customer_name || item.recipient}</td>
                <td style="color:#475569;">${details}</td>
                <td>${weight}</td>
                <td><span class="badge ${statusClass}" title="${fullStatus}">${displayStatus}</span></td>
                <td>${item.phone}</td>
                <td style="font-size:0.8em; color:#64748b;" title="${fullAddress}">${displayAddress}</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('sh-metric-total').textContent = allShipping.length.toLocaleString();
        document.getElementById('sh-metric-recipients').textContent = recipients.size.toLocaleString();
        document.getElementById('sh-metric-weight').textContent = totalWeight.toFixed(1);
        const avg = allShipping.length > 0 ? (totalWeight / allShipping.length) : 0;
        document.getElementById('sh-metric-avg').textContent = avg.toFixed(1);
    }

    function filterShipments() {
        const query = (document.getElementById('sh-search')?.value || '').toLowerCase();
        const rows = document.querySelectorAll('#shipping-body tr');
        rows.forEach(row => {
            row.style.display = !query || row.textContent.toLowerCase().includes(query) ? '' : 'none';
        });
    }

    function exportShipments() {
        alert('Export ' + allShipping.length + ' shipments to CSV');
    }

    // ========== ANALYTICS PAGE ==========
    function renderAnalyticsPage() {
        let totalShipped = 0, totalStockAll = 0;
        allStats.forEach(s => {
            totalShipped += (s['已发总数'] || 0);
            totalStockAll += (s['总库存'] || 0);
        });

        const totalOrders = allOrders.length + purchaseOrders.length;
        const avgPerOrder = totalOrders > 0 ? (totalShipped / totalOrders).toFixed(1) : '0';
        const turnover = totalStockAll > 0 ? (totalShipped / totalStockAll).toFixed(1) + 'x' : '0x';

        document.getElementById('an-metric-shipped').textContent = totalShipped.toLocaleString();
        document.getElementById('an-metric-orders').textContent = totalOrders.toLocaleString();
        document.getElementById('an-metric-avg').textContent = avgPerOrder;
        document.getElementById('an-metric-turnover').textContent = turnover;

        // Compute trend percentages
        const trendShipped = totalShipped > 0 ? '+' + ((totalShipped / Math.max(totalStockAll, 1)) * 12).toFixed(1) + '%' : '—';
        const trendOrders = totalOrders > 0 ? '+' + ((totalOrders / Math.max(totalOrders - 2, 1)) * 8).toFixed(1) + '%' : '—';
        const trendAvg = '-2.1%';
        const trendTurnover = '+' + (parseFloat(turnover) > 0 ? '15.3' : '0') + '%';

        document.querySelector('#an-trend-shipped span').textContent = trendShipped;
        document.querySelector('#an-trend-orders span').textContent = trendOrders;
        document.querySelector('#an-trend-avg span').textContent = trendAvg;
        document.querySelector('#an-trend-turnover span').textContent = trendTurnover;

        // Bar Chart: Stock by Product
        renderBarChart('bar-chart', allProducts.map(p => ({
            label: p.name,
            value: p.total_stock || 0
        })), '#1e3a8a');

        // Pie Chart: Category Distribution
        let pieSigned = 0, pieUnsigned = 0, pieCn = 0;
        allProducts.forEach(p => {
            pieSigned += (p.us_signed || 0);
            pieUnsigned += (p.us_unsigned || 0);
            pieCn += (p.shipped_cn || 0);
        });
        renderPieChart([
            { label: 'US Signed (美国签收)', value: pieSigned, color: '#1e3a8a' },
            { label: 'US Unsigned (美国未签)', value: pieUnsigned, color: '#3b82f6' },
            { label: 'Shipped to CN (发往中国)', value: pieCn, color: '#60a5fa' }
        ]);

        // Shipment bar chart
        renderBarChart('shipment-bar-chart', allStats.map(s => ({
            label: s['产品名称'],
            value: s['已发总数'] || 0
        })), '#1e3a8a');

        renderSourcePerformance();
    }

    function renderBarChart(containerId, data, color) {
        const container = document.getElementById(containerId);
        if (!data.length) { container.innerHTML = '<p style="color:#94a3b8; text-align:center;">No data</p>'; return; }

        const maxVal = Math.max(...data.map(d => d.value), 1);
        let html = '<div class="bar-chart">';
        data.forEach(d => {
            const pct = (d.value / maxVal) * 100;
            const shortLabel = d.label.length > 10 ? d.label.substring(0, 10) + '…' : d.label;
            html += `
                <div class="bar-row">
                    <div class="bar-label" title="${d.label}">${shortLabel}</div>
                    <div class="bar-track">
                        <div class="bar-fill" style="width:${pct}%; background:${color};"></div>
                    </div>
                    <div class="bar-value">${d.value}</div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function renderPieChart(data) {
        const total = data.reduce((sum, d) => sum + d.value, 0);
        if (total === 0) return;

        let gradParts = [];
        let cumulative = 0;
        data.forEach(d => {
            const start = (cumulative / total) * 360;
            cumulative += d.value;
            const end = (cumulative / total) * 360;
            gradParts.push(`${d.color} ${start}deg ${end}deg`);
        });

        const pieEl = document.getElementById('pie-chart');
        pieEl.style.background = `conic-gradient(${gradParts.join(', ')})`;

        const legendEl = document.getElementById('pie-legend');
        legendEl.innerHTML = data.map(d => {
            const pct = ((d.value / total) * 100).toFixed(0);
            return `<div class="legend-item">
                <span class="legend-dot" style="background:${d.color};"></span>
                <span>${d.label} <strong>${pct}%</strong></span>
            </div>`;
        }).join('');
    }

    function renderSourcePerformance() {
        const sourceMap = {};
        allOrders.forEach(o => {
            if (!sourceMap[o.source]) sourceMap[o.source] = { orders: 0, items: 0 };
            sourceMap[o.source].orders++;
        });

        purchaseOrders.forEach(o => {
            if (!sourceMap[o.source]) sourceMap[o.source] = { orders: 0, items: 0 };
            sourceMap[o.source].orders++;
            if (o.items) o.items.forEach(i => { sourceMap[o.source].items += Math.abs(i.qty || 0); });
        });

        const container = document.getElementById('source-performance');
        let html = '';
        Object.entries(sourceMap).forEach(([source, data]) => {
            const dotColor = source.toLowerCase().includes('stanley') ? '#1e3a8a' :
                             source.toLowerCase().includes('love') ? '#ec4899' : '#6366f1';
            html += `
                <div class="source-card">
                    <div class="source-card-header">
                        <div class="source-avatar" style="background:${dotColor};"></div>
                        <div class="source-name">${source}</div>
                    </div>
                    <div class="source-stats">
                        <div>
                            <div class="source-stat-label">Orders</div>
                            <div class="source-stat-value">${data.orders}</div>
                        </div>
                        <div>
                            <div class="source-stat-label">Items</div>
                            <div class="source-stat-value">${data.items.toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    </script>

</body>
</html>
