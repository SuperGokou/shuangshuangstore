<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>觉觉在北美</title>
    <link rel="icon" href="img/icon.png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

	<div class="header-wrapper">
        <h1>觉觉在北美 (amtfmz)</h1>
        <a href="pages/login.html" class="login-btn">登陆</a>
    </div>

    <div class="subtitle">
        <span class="live-dot"></span> Live Stock Status
        <span id="last-updated" style="font-size:0.8em; color:#94a3b8; margin-left:10px;"></span>
    </div>

    <div id="inventory-container" class="gallery-scroll">
        <p style="text-align:center; width:100%;">Loading products...</p>
    </div>

	<div class="orders-section">
			<h2>产品发货统计 (Shipment Stats)</h2>
			<div class="table-wrapper">
				<table id="stats-table">
					<thead>
						<tr>
							<th style="width: 50px;">图片</th>
							<th>产品名称</th>
							<th>已发总数</th>

							<th>带包装 (Qty)</th>
							<th>明细 (Details)</th>

							<th>不带包装 (Qty)</th>
							<th>明细 (Details)</th>

							<th>总库存</th>
						</tr>
					</thead>
					<tbody id="stats-body"></tbody>
				</table>
			</div>
		</div>


    <div class="orders-section">
        <h2>君安快递追踪 (JunAn Express)</h2>
        <div class="table-wrapper">
            <table id="shipping-table">
                <thead>
                    <tr>
                        <th>运单号</th>
                        <th>收件人</th>
                        <th>内件明细</th>
                        <th>重量(lbs)</th>
                        <th>状态</th>
                        <th>电话</th>
                        <th>地址</th>
                    </tr>
                </thead>
                <tbody id="shipping-body"></tbody>
            </table>
        </div>
    </div>


	<div class="orders-section">
			<h2>采购订单记录 (My Purchase History)</h2>
			<div class="scroll-table-wrapper">
				<table id="purchase-table">
					<thead>
						<tr>
							<th style="min-width: 100px;">日期 (Date)</th>
							<th style="min-width: 120px;">来源 (Source)</th>
							<th style="min-width: 300px;">产品明细 (Items)</th>
							<th style="min-width: 180px;">快递单号 (Tracking)</th>
							<th style="min-width: 120px;">备注 (Note)</th>
						</tr>
					</thead>
					<tbody id="purchase-body"></tbody>
				</table>
			</div>
		</div>


    <div class="orders-section">
        <h2>采购订单追踪 (Incoming Orders)</h2>
        <div class="table-wrapper">
            <table id="order-table">
                <thead>
                    <tr>
                        <th>来源 (Source)</th>
                        <th>订单号 (Order #)</th>
                        <th>状态</th>
                        <th>快递单号</th>
                        <th>签收</th>
                        <th>预计 (Est. Date)</th>
                    </tr>
                </thead>
                <tbody id="order-body"></tbody>
            </table>
        </div>
    </div>

	<script>
    // --- 0. FETCH STATS ---
    fetch('data/stats.json')
        .then(res => res.ok ? res.json() : [])
        .then(stats => {
            const tbody = document.getElementById('stats-body');
            if(stats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No stats available</td></tr>';
                return;
            }

            stats.forEach(item => {
                const row = document.createElement('tr');
                const safeImg = encodeURI(item.image || '');

                row.innerHTML = `
                    <td>
                        <div class="image-wrapper" style="width: 50px; height: 50px;">
                            <img src="${safeImg}" alt="img" style="width:100%; height:100%; object-fit:contain;"
                                 onerror="this.src='https://via.placeholder.com/50?text=?'">
                        </div>
                    </td>
                    <td style="font-weight:bold; color:#0f172a;">${item['产品名称']}</td>
                    <td style="font-size:1.1em; font-weight:bold;">${item['已发总数']}</td>
                    <td style="font-weight:bold; color:#16a34a; text-align:center;">${item['带包装']}</td>
                    <td style="font-size:0.85em; color:#64748b; max-width:150px;">${item['带包装详情']}</td>
                    <td style="font-weight:bold; color:#dc2626; text-align:center;">${item['不带包装']}</td>
                    <td style="font-size:0.85em; color:#64748b; max-width:150px;">${item['不带包装详情']}</td>
                    <td style="font-weight:bold;">${item['总库存']}</td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(err => console.error("Stats Error:", err));

    // --- 1. FETCH PRODUCTS ---
    fetch('data/products.json')
        .then(res => { if (!res.ok) throw new Error("File not found"); return res.json(); })
        .then(products => {
            const container = document.getElementById('inventory-container');
            container.innerHTML = '';

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'card';
                const safeImagePath = encodeURI(product.image);
                const usSigned = product.us_signed || 0;
                const usUnsigned = product.us_unsigned || 0;
                const shippedCn = product.shipped_cn || 0;
                const totalStock = product.total_stock || 0;

                card.innerHTML = `
                    <div class="image-wrapper">
                        <img src="${safeImagePath}" alt="${product.name}" loading="lazy"
                             onerror="this.src='https://via.placeholder.com/300?text=No+Image'">
                    </div>
                    <div class="info">
                        <h3 style="text-align: center;">${product.name}</h3>
                        <div class="stock-data">
                            <div class="stock-row"><span class="stock-label">美国签收:</span><span class="stock-value" style="color:#16a34a;">${usSigned}</span></div>
                            <div class="stock-row"><span class="stock-label">美国未签:</span><span class="stock-value" style="color:#d97706;">${usUnsigned}</span></div>
                            <div class="stock-row"><span class="stock-label">发往中国:</span><span class="stock-value">${shippedCn}</span></div>
                            <div style="border-top: 1px solid #e2e8f0; margin-top:2px; padding-top:2px;" class="stock-row">
                                <span class="stock-label">商品总数:</span><span class="stock-value"><strong>${totalStock}</strong></span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        })
        .catch(err => {
            console.error("Product Error:", err);
            document.getElementById('inventory-container').innerHTML = '<p>Error loading products.</p>';
        });

    // --- 2. FETCH SHIPPING ---
    fetch('data/shipping.json')
        .then(res => res.ok ? res.json() : [])
        .then(items => {
            const tbody = document.getElementById('shipping-body');
            if(items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No shipping data found.</td></tr>';
                return;
            }
            items.forEach(item => {
                const row = document.createElement('tr');
                const details = item.details || item['内件明细'] || '——';
                const weight = item.weight || item['实际重量'] || '——';
                let trackingDisplay = item.tracking_number;
                if (item.tracking_url) {
                    trackingDisplay = `<a href="${item.tracking_url}" target="_blank">${item.tracking_number}</a>`;
                }

                // Address Truncation
                let fullAddress = item.address || '';
                let displayAddress = fullAddress;
                if (fullAddress.length > 25) {
                    displayAddress = fullAddress.substring(0, 9) + "......" + fullAddress.substring(fullAddress.length - 9);
                }

                // Status Truncation
                let fullStatus = item.status || 'Checking...';
                let displayStatus = fullStatus;
                if (fullStatus.length > 16) {
                    displayStatus = fullStatus.substring(0, 16) + '...';
                }

                row.innerHTML = `
                    <td class="tracking-code">${trackingDisplay}</td>
                    <td>${item.customer_name || item.recipient}</td>
                    <td style="color:#475569;">${details}</td>
                    <td>${weight}</td>
                    <td><span class="status-badge" title="${fullStatus}">${displayStatus}</span></td>
                    <td>${item.phone}</td>
                    <td style="font-size:0.8em; color:#64748b;" title="${fullAddress}">${displayAddress}</td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(err => console.error("Shipping Error:", err));

    // --- 3. FETCH ORDERS ---
    fetch('data/orders.json')
        .then(res => res.ok ? res.json() : [])
        .then(orders => {
            const tbody = document.getElementById('order-body');
            if(orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No orders found.</td></tr>';
                return;
            }
            orders.forEach(order => {
                const row = document.createElement('tr');
                let badgeStyle = 'padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 600; display: inline-block;';
                if (order.status === 'Fulfilled' || order.status === 'Shipped') {
                    badgeStyle += 'background-color: #dcfce7; color: #166534;';
                } else if (order.status === 'Partial') {
                    badgeStyle += 'background-color: #dbeafe; color: #1e40af;';
                } else {
                    badgeStyle += 'background-color: #fef9c3; color: #854d0e;';
                }

                let signedText = order.signed;
                let signedColor = 'color:#16a34a;';
                if (String(signedText).includes('No') || String(signedText).includes('否')) {
                    signedColor = 'color:#dc2626; font-weight:bold;';
                }

                let trackingDisplay = order.tracking;
                if (order.tracking_url && order.tracking !== '——' && order.tracking !== '-') {
                    trackingDisplay = `<a href="${order.tracking_url}" target="_blank">${order.tracking}</a>`;
                }

                row.innerHTML = `
                    <td>${order.source}</td>
                    <td>${order.order_id}</td>
                    <td><span style="${badgeStyle}">${order.status}</span></td>
                    <td class="tracking-code">${trackingDisplay}</td>
                    <td style="${signedColor}">${signedText}</td>
                    <td>${order.est_date || '——'}</td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(err => console.error("Order Error:", err));

// --- 4. FETCH PURCHASE ORDERS (With Database Sync) ---
    // Global storage
    let purchaseOrders = [];

    function toggleSignStatus(orderIndex, shipmentIndex, isChecked) {
        const order = purchaseOrders[orderIndex];
        if (!order || !order.shipments) return;
        const shipment = order.shipments[shipmentIndex];

        // Update local model
        shipment.local_signed = isChecked ? 'Yes' : 'No';
        console.log(`Updated: ${shipment.tracking_number} -> ${shipment.local_signed}`);

        // Save to LocalStorage
        const uniqueKey = `${order.order_id}_${shipment.tracking_number}`;
        const savedState = JSON.parse(localStorage.getItem('purchase_signed_state') || '{}');
        if (isChecked) savedState[uniqueKey] = 'Yes';
        else delete savedState[uniqueKey];
        localStorage.setItem('purchase_signed_state', JSON.stringify(savedState));
    }

    fetch('data/purchase_orders.json')
        .then(res => res.ok ? res.json() : [])
        .then(orders => {
            purchaseOrders = orders;
            const savedState = JSON.parse(localStorage.getItem('purchase_signed_state') || '{}');
            const tbody = document.getElementById('purchase-body');
            tbody.innerHTML = '';

            if(orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No purchase history found.</td></tr>';
                return;
            }

            orders.forEach((order, orderIndex) => {
                const row = document.createElement('tr');

                // 1. Items HTML
                let itemsHtml = '<div style="display:flex; flex-direction:column; gap:8px;">';
                if (order.items && order.items.length > 0) {
                    order.items.forEach(item => {
                        const safeImg = encodeURI(item.image || '');
                        itemsHtml += `
                            <div style="display:flex; align-items:center; gap:10px; border-bottom:1px dashed #e2e8f0; padding-bottom:4px;">
                                <div style="width:40px; height:40px; flex-shrink:0;">
                                    <img src="${safeImg}" alt="img" style="width:100%; height:100%; object-fit:contain; border-radius:4px;"
                                         onerror="this.src='https://via.placeholder.com/40?text=?'">
                                </div>
                                <div style="font-size:0.9em; line-height:1.2; white-space: normal;">
                                    <div style="font-weight:bold; color:#0f172a;">${item.product}</div>
                                    <div style="color:#64748b;">Qty: <span style="color:#16a34a; font-weight:bold;">${item.qty}</span></div>
                                </div>
                            </div>
                        `;
                    });
                }
                itemsHtml += '</div>';

                // 2. Tracking HTML (Database Linked Checkbox)
                let trackingHtml = '<span style="color:#94a3b8;">-</span>';
                if (order.shipments && order.shipments.length > 0) {
                    trackingHtml = order.shipments.map((s, shipmentIndex) => {
                        const fullNum = s.tracking_number;
                        const uniqueKey = `${order.order_id}_${fullNum}`;

                        let isSigned = false;
                        if (savedState[uniqueKey]) {
                            isSigned = savedState[uniqueKey] === 'Yes';
                        } else {
                            isSigned = s.signed === 'Yes' || s.signed === '是';
                        }

                        const checkedAttr = isSigned ? 'checked' : '';

                        return `
                        <div style="margin-bottom:6px; display:flex; align-items:center; gap:8px;">
                            <input type="checkbox"
                                   style="cursor:pointer; accent-color: #2563eb; width:16px; height:16px;"
                                   ${checkedAttr}
                                   onchange="toggleSignStatus(${orderIndex}, ${shipmentIndex}, this.checked)"
                                   title="Mark as signed">

                            <span style="font-size:0.8em; color:#64748b; font-weight:bold;">${s.carrier}:</span>

                            <a href="${s.tracking_url}" target="_blank" title="${fullNum}"
                               style="font-family:monospace; font-size:1.1em;">
                                ${fullNum}
                            </a>
                        </div>`;
                    }).join('');
                }

                // 3. Note Styling
                let noteStyle = 'font-weight:bold; color:#d97706;';
                const noteText = order.note || '';
                if (noteText.includes('已发货') && noteText.includes('已签收')) {
                    noteStyle = 'font-weight:bold; color:#16a34a;';
                } else if (noteText.includes('已发货') && noteText.includes('未签收')) {
                    noteStyle = 'font-weight:bold; color:#2563eb;';
                }else if(noteText.includes('退货')){
					noteStyle = 'font-weight:bold; color:#16a34a;';
				}

                row.innerHTML = `
                    <td style="font-size:0.9em; color:#64748b;">${order.date}</td>
                    <td>
                        <div style="font-weight:bold;">${order.source}</div>
                        <div style="font-size:0.8em; color:#94a3b8;">${order.order_id}</div>
                    </td>
                    <td style="white-space: normal; min-width: 300px;">${itemsHtml}</td>
                    <td>${trackingHtml}</td>
                    <td style="${noteStyle}">${order.note || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(err => console.error("Purchase History Error:", err));
</script>

</body>
</html>
